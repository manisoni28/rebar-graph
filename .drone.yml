kind: pipeline
name: default

services:
- name: neo4j
  image: neo4j
  environment:
    NEO4J_AUTH: "none"
    NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"

steps:
- name: build
  image: openjdk:8
  environment:
    GRAPH_URL: bolt://neo4j:7687
  commands:
  - env
  - pwd
  - ./gradlew dependencies
  - ./tools/wait-for-neo4j
  - ./gradlew clean build
- name: "docker image - kubernetes"
  image: plugins/docker
  settings:
    context: rebar-graph-kubernetes
    repo: rebar/rebar-graph-kubernetes
    dockerfile: rebar-graph-kubernetes/Dockerfile
    auto_tag: true
    username: 
        from_secret: DOCKER_REGISTRY_USERNAME
    password:
        from_secret: DOCKER_REGISTRY_PASSWORD
- name: "docker image - AWS"
  image: plugins/docker
  settings:
    context: rebar-graph-aws
    repo: rebar/rebar-graph-aws
    dockerfile: rebar-graph-aws/Dockerfile
    auto_tag: true
    username: 
        from_secret: DOCKER_REGISTRY_USERNAME
    password:
        from_secret: DOCKER_REGISTRY_PASSWORD

